---
title: "05_analysis_03"
author: "Miguel Blanco"
format: html
editor: visual
---

## Statistical analysis of Paxlovid effect on Lymphocytes

### 1. Check normality

```{r}
data |>
  pull(`D7_lymphocyte_count[10^9/L]`) |> 
  shapiro.test()
```

Visualization of distribution

```{r}
Lymp_dist <- ggplot(data, aes(x = `D7_lymphocyte_count[10^9/L]`)) +
  geom_histogram(binwidth = 0.5, fill = "skyblue", color = "black") +
  labs(title = "Distribution of Day 7 Lymphocyte Levels [10^9/L]", x = "Lymphocyte Levels", y = "Count") +
  xlim(0,4)+
  theme_minimal()+
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

ggsave("../results/05_Lymp_distribution.png", plot = Lymp_dist, 
       width = 10, height = 6, dpi = 300)
```

### 2. Wilcox-test and summary stats

Summary statistics

```{r}

lymph_stats <- data |> 
  group_by(`Antiviral_drugs_(1_nema_0_no)`) |> 
  summarise(
    median_lymphocytes_D7 = median(`D7_lymphocyte_count[10^9/L]`, na.rm = TRUE),
    mean_lymphocytes_D7 = mean(`D7_lymphocyte_count[10^9/L]`, na.rm = TRUE),
    count = n(),
    median_lymphocytes_D1 = median(`D1_lymphocyte_count[10^9/L]`, na.rm = TRUE),
    mean_lymphocytes_D1 = mean(`D1_lymphocyte_count[10^9/L]`, na.rm = TRUE),
    count = n()
  )
```

Wilcox test

```{r}
wilcox_res <- wilcox.test(
  `D7_lymphocyte_count[10^9/L]` ~ `Antiviral_drugs_(1_nema_0_no)`,
  data = data
)

print(wilcox_res)
```

```{r}
p1 <- ggplot(data = data,
       mapping = aes(x = `Antiviral_drugs_(1_nema_0_no)`,
                     y = `D1_lymphocyte_count[10^9/L]`)) +
  geom_boxplot()+
  ylim(0,2)+
  theme_minimal()

p2 <- ggplot(data = data |> filter(`D7_lymphocyte_count[10^9/L]` < 15),
       mapping = aes(x = `Antiviral_drugs_(1_nema_0_no)`,
                     y = `D7_lymphocyte_count[10^9/L]`)) +
  ylim(0,2)+
  geom_boxplot()+
  theme_minimal()

p1+p2
```

Paxlovid graphs

```{r}
  #death
p1 <- ggplot(data_lym, aes(x = Day, y = Lymphocytes, color = Death)) +
  geom_boxplot(aes(fill = Death), outlier.shape = NA, alpha = 0.8) + 
  geom_jitter(aes(shape = `Antiviral_drugs_(1_nema_0_no)`), size = 2, alpha = 0.8, position = position_jitter(width = 0.15)) + 
      scale_fill_manual(
    values = c("Yes" = "#5995ED", "No" = "#DB3069"), # Match colors from ages_plot
    labels = c("Yes" = "1", "No" = "0") # Update Death legend labels
  ) +
  scale_color_manual(
    values = c("Yes" = "#5995ED", "No" = "#DB3069"), # Match colors from ages_plot
    labels = c("Yes" = "1", "No" = "0") # Update Death legend labels
  ) +
  labs(
    title = "Lymphocyte Counts on Day 1 and Day 7",
    x = "Day",
    y = "Lymphocyte Count",
    color = "Death",
    shape = "Paxlovid Consumption",
    fill = "Death"
  ) +
  #scale_y_continuous(limits = c(0, 3)) + # Adjust y-axis limits to match data
  scale_x_discrete(labels = c("D1_LC", "D7_LC")) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    legend.position = "top"
  ) +
  facet_wrap(~Death, scales = "free")

#sin los outliers
p2 <- ggplot(data_lym, aes(x = Day, y = Lymphocytes, color = Death)) +
  geom_boxplot(aes(fill = Death), outlier.shape = NA, alpha = 0.8) + # Solid boxplots
  #geom_jitter(aes(shape = `Antiviral_drugs_(1_nema_0_no)`), size = 2, alpha = 0.8, position = position_jitter(width = 0.15)) + 
  stat_summary(fun = median, geom = "text", aes(label = sprintf("%.2f", ..y..)), 
               position = position_dodge(width = 0.75), vjust = -0.5, color = "black", size = 3) + # Add median values
      scale_fill_manual(
    values = c("Yes" = "#5995ED", "No" = "#DB3069"), # Match colors from ages_plot
    labels = c("Yes" = "1", "No" = "0") # Update Death legend labels
  ) +
  scale_color_manual(
    values = c("Yes" = "#5995ED", "No" = "#DB3069"), # Match colors from ages_plot
    labels = c("Yes" = "1", "No" = "0") # Update Death legend labels
  ) +
  labs(
    title = "Lymphocyte Counts on Day 1 and Day 7",
    x = "Day",
    y = "Lymphocyte Count",
    color = "Death",
    shape = "Paxlovid Consumption",
    fill = "Death"
  ) +
  scale_y_continuous(limits = c(0, 3)) + # Adjust y-axis limits to match data
  scale_x_discrete(labels = c("D1_LC", "D7_LC")) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    legend.position = "top"
  ) +
  facet_wrap(~Death, scales = "free")

(p1 + p2)
```

```{r}
  p1 <- ggplot(data_lym |> filter(Day == "D7_lymphocyte_count[10^9/L]"), aes(x = Day, y = Lymphocytes, color = `Antiviral_drugs_(1_nema_0_no)`)) +
  geom_boxplot(aes(fill = `Antiviral_drugs_(1_nema_0_no)`), alpha = 0.8, show.legend = FALSE) + 
  scale_fill_manual(
    values = c("Yes" = "#5995ED", "No" = "#DB3069"), 
    labels = c("Yes" = "1", "No" = "0") 
  ) +
  scale_color_manual(
    values = c("Yes" = "#5995ED", "No" = "#DB3069"), 
    labels = c("Yes" = "1", "No" = "0") 
  ) +
  labs(
    title = "Lymphocyte Counts on Day 7",
    x = "Day",
    y = "Lymphocyte Count",
    color = "Paxlovid Consumption",
  ) +
  #scale_y_continuous(limits = c(0, 3)) + # Adjust y-axis limits to match data
  scale_x_discrete(labels = "D7_LC") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    legend.position = "none" 
)

p2 <- ggplot(data_lym |> filter(Day == "D7_lymphocyte_count[10^9/L]"), aes(x = Day, y = Lymphocytes, color = `Antiviral_drugs_(1_nema_0_no)`)) +
  geom_boxplot(aes(fill = `Antiviral_drugs_(1_nema_0_no)`), outlier.shape = NA, alpha = 0.8, show.legend = FALSE) + 
  scale_fill_manual(
    values = c("Yes" = "#5995ED", "No" = "#DB3069"), 
    labels = c("Yes" = "1", "No" = "0") 
  ) +
  scale_color_manual(
    values = c("Yes" = "#5995ED", "No" = "#DB3069"), 
    labels = c("Yes" = "1", "No" = "0") 
  ) +
  labs(
    title = "Lymphocyte Counts on Day 7",
    x = "Day",
    y = "Lymphocyte Count",
    color = "Paxlovid Consumption",
  ) +
  scale_y_continuous(limits = c(0, 3)) + # Adjust y-axis limits to match data
  scale_x_discrete(labels = "D7_LC") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    legend.position = "none"
  ) 

(p1 + p2) +
   plot_annotation(
    title = "Lymphocyte Counts on Day 7")
```
