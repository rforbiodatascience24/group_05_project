---
title: "PCA"
author: "DGC"
format: html
editor: visual
---

```{r}
data_lym <- data |>
  select("D1_lymphocyte_count[10^9/L]","D7_lymphocyte_count[10^9/L]", "Antiviral_drugs_(1_nema_0_no)","Death")
```

```{r}
data_lym <- data_lym |>
  pivot_longer(cols = c(`D1_lymphocyte_count[10^9/L]`, `D7_lymphocyte_count[10^9/L]`), names_to = "Day", values_to = "Lymphocytes") |>
  mutate(`Antiviral_drugs_(1_nema_0_no)` = factor(
    `Antiviral_drugs_(1_nema_0_no)`, 
    levels = c(0,1),
    labels = c("No", "Yes"))) |>
  mutate(Death = factor(Death, levels = c(0, 1), labels = c("No", "Yes")))
```

```{r}
data_lym |> summarise(mean(Lymphocytes, na.rm = TRUE))
```

```{r}
ggplot(data_lym, aes(x=Day, y = Lymphocytes, color = Death, group = `Antiviral_drugs_(1_nema_0_no)`)) +
  geom_point(size = 3, aes(shape = `Antiviral_drugs_(1_nema_0_no)`), position = position_jitter(width = 0.35)) +
    labs(
    title = "Lymphocyte Counts on Day 1 and Day 7",
    x = "Day",
    y = "Lymphocyte Count",
    color = "Death",
    linetype = "Paxlovid Consumption",
    shape = "Paxlovid Consumption"
  ) +
  scale_y_continuous(limits = c(0, 3)) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "top"
  ) +
  facet_wrap(~Death, scales = "free")
```

```{r}
ggplot(data_lym, aes(x = Day, y = Lymphocytes, color = Death)) +
  geom_boxplot(aes(fill = Death), alpha = 0.5, outlier.shape = NA) + # Boxplot with transparency
  geom_jitter(aes(shape = `Antiviral_drugs_(1_nema_0_no)`), size = 2, position = position_jitter(width = 0.2)) + # Jittered points overlaid
  labs(
    title = "Lymphocyte Counts on Day 1 and Day 7",
    x = "Day",
    y = "Lymphocyte Count",
    color = "Death",
    shape = "Paxlovid Consumption",
    fill = "Death"
  ) +
  scale_y_continuous(limits = c(0, 3)) + # Adjust y-axis limits to match data
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "top"
  )
```

```{r}
ggplot(data_lym, aes(x = Day, y = Lymphocytes, color = Death)) +
  geom_boxplot(aes(fill = Death), outlier.shape = NA, alpha = 0.8) + # Solid boxplots
  geom_jitter(aes(shape = `Antiviral_drugs_(1_nema_0_no)`), size = 2, alpha = 0.8, position = position_jitter(width = 0.15)) + 
  stat_summary(fun = median, geom = "text", aes(label = sprintf("%.2f", ..y..)), 
               position = position_dodge(width = 0.75), vjust = -0.5, color = "black", size = 3) + # Add median values
  labs(
    title = "Lymphocyte Counts on Day 1 and Day 7",
    x = "Day",
    y = "Lymphocyte Count",
    color = "Death",
    shape = "Paxlovid Consumption",
    fill = "Death"
  ) +
    scale_fill_manual(
    values = c("1" = "#5995ED", "0" = "#DB3069"), # Match colors from ages_plot
    labels = c("1" = "Yes", "0" = "No") # Update Death legend labels
  ) +
  scale_color_manual(
    values = c("1" = "#5995ED", "0" = "#DB3069"), # Match jitter point colors to boxplot fills
    labels = c("1" = "Yes", "0" = "No") # Update Death legend labels
  ) +
  scale_y_continuous(limits = c(0, 3)) + # Adjust y-axis limits to match data
  scale_x_discrete(labels = c("D1_LC", "D7_LC")) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    legend.position = "top"
  ) +
  facet_wrap(~Death, scales = "free") 
```

```{r}
ggplot(data_lym, aes(x = Day, y = Lymphocytes)) +
  geom_boxplot(aes(fill = as.factor(Death)), outlier.shape = NA, alpha = 0.8) + # Boxplot with colors
  geom_jitter(aes(color = as.factor(Death), shape = as.factor(`Antiviral_drugs_(1_nema_0_no)`)), 
              size = 2, alpha = 0.8, position = position_jitter(width = 0.15)) + 
  stat_summary(fun = median, geom = "text", aes(label = sprintf("%.2f", ..y..)), 
               position = position_dodge(width = 0.75), vjust = -0.5, color = "black", size = 3) + # Add median values
  labs(
    title = "Lymphocyte Counts on Day 1 and Day 7",
    x = "Day",
    y = "Lymphocyte Count",
    color = "Death",
    shape = "Paxlovid Consumption",
    fill = "Death"
  ) +
  scale_fill_manual(
    values = c("1" = "#5995ED", "0" = "#DB3069"), # Custom colors for boxplot
    labels = c("1" = "Yes", "0" = "No") # Custom legend labels
  ) +
  scale_color_manual(
    values = c("1" = "#5995ED", "0" = "#DB3069"), # Custom colors for jitter points
    labels = c("1" = "Yes", "0" = "No") # Custom legend labels
  ) +
  scale_y_continuous(limits = c(0, 3)) + # Adjust y-axis limits
  scale_x_discrete(labels = c("D1_LC", "D7_LC")) + # Update x-axis labels
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    legend.position = "top"
  ) +
  facet_wrap(~Death, scales = "free") # Facet by Death status

```

```{r}
ggplot(data_lym, aes(x = Day, y = Lymphocytes, fill = Death)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.8, color = "black") + # Add black border to boxplots
  geom_jitter(aes(shape = `Antiviral_drugs_(1_nema_0_no)`), size = 2, alpha = 0.8, position = position_jitter(width = 0.15)) + 
  stat_summary(fun = median, geom = "text", aes(label = sprintf("%.2f", ..y..)), 
               position = position_dodge(width = 0.75), vjust = -0.5, color = "black", size = 3) + # Add median values
  scale_fill_manual(
    values = c("1" = "#5995ED", "0" = "#DB3069"), # Match colors from ages_plot
    labels = c("1" = "Deceased", "0" = "Survived") # Update Death legend labels
  ) +
  scale_color_manual(
    values = c("1" = "#5995ED", "0" = "#DB3069"), # Match jitter point colors to boxplot fills
    labels = c("1" = "Deceased", "0" = "Survived") # Update Death legend labels
  ) +
  scale_y_continuous(limits = c(0, 3)) + # Adjust y-axis limits
  scale_x_discrete(labels = c("D1_LC", "D7_LC")) + # Update x-axis labels
  labs(
    title = "Lymphocyte Counts on Day 1 and Day 7",
    x = "Day",
    y = "Lymphocyte Count",
    fill = "Outcome", # Update legend title to match ages_plot
    color = "Outcome", # Match jitter points legend title to boxplot
    shape = "Paxlovid Consumption"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1), # Angle x-axis labels to match ages_plot
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    legend.position = "top" # Move legend to the top
  ) +
  facet_wrap(~Death, scales = "free") # Facet the plot by Death status

```

```{r}
data_PCA <- data |>
  select("Viral_persistence_time[days]", "Antiviral_Drug", "Medication_days", "Hormones", "Hormone_usage_days", "Immunotherapy", "Antibiotics", "Anticoagulation", "Anticoagulant_days", "Mechanical_ventilation_days", "Vasoactive_drugs", "Mask_Oxygen_therapy", "NonInvasive_Oxygen_therapy", "Invasive_Oxygen_therapy", "HighFlow_Oxygen_therapy", "ECMO", "Death") 

```

```{r}
data_PCA_mutate <- data_PCA |>
  mutate(`Antiviral_Drug` = case_when(
    `Antiviral_Drug` == "None" ~ 0,
    `Antiviral_Drug` == "Paxlovid" ~ 1,
    `Antiviral_Drug` == "Azduvine" ~ 2,
    TRUE ~ NA 
    )) |>
  mutate(`Hormones` = case_when(
    `Hormones` == "Methylprednisolone" ~ 1,
    `Hormones` == "Dexamethasone" ~ 2,
    `Hormones` == "Other" ~ 3,
    TRUE ~ NA
  ))  |>
    mutate(`Immunotherapy` = case_when(
    `Immunotherapy` == "Tocilizumab" ~ 1,
    `Immunotherapy` == "Baricitinib" ~ 2,
    `Immunotherapy` == "None" ~ 0,
    TRUE ~ NA
  ))  |>
  mutate(`Hormone_usage_days` = case_when(
   `Hormone_usage_days` == "long treatment" ~ 20,
   TRUE ~ as.numeric(`Hormone_usage_days`)
  ))
```

```{r}
pca_fit <- data_PCA_mutate |>
  select(where(is.numeric)) |> # retain only numeric columns
  scale() |> # scale data
  prcomp() # do PCA
```

```{r}
pca_fit <- data_PCA_mutate |>
  select(where(is.numeric)) |> # retain only numeric columns
  scale() |> # scale data
  as.data.frame() |> # convert scaled matrix back to data frame
  prcomp() # do PCA

```
