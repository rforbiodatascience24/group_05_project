---
title: "Project"
author: "Miguel Blanco, Xavi Chapatte, Luis Martín"
format: html
editor: visual
---

### Load libraries

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(readxl)
library(stringr)

```

Load Data

```{r, warning=FALSE, message=FALSE}
data <- read_tsv("../data/01_dat_load.tsv")
```

Change values \[null\] for NAs

```{r}

#Notice that na_if function has to work with the same type of values at the time. For example in this df we have both character and numeric values, so we have to do it in 2 times


#The function takes the data (data) and the vector of all the values that we want to be considered as NAs (na_vector). This na_vector should be specified as 
# c("null", "-"...)
NA_values_replace <- function(data, na_vector){
  data |> 
    mutate(across(where(is.character), ~ case_when 
          (. %in% na_vector ~ NA,
          TRUE ~ .
          )))
}

data <- NA_values_replace(data = data, 
                          na_vector = c("[null]", "/", "-"))

```

Proportions of NA in each column

```{r}

#The function takes the data as only argument and return the proportion of NA values of each column in the data 
NA_prop <- function(data) {
  data |> 
    select(where(anyNA)) |> 
    summarise(across(everything(), ~ mean(is.na(.)), .names = "{col}")) |> 
    pivot_longer(everything(), values_to = "na_proportion", names_to = "column")
}

data_NA_proportion <- NA_prop(data)
```

Remove empty columns that were introduced as separators. 
```{r}
data <- data |> 
  select(-"Pulmonary CT condition",
         -"D1 blood routine upon admission",
         -"D7 blood routine",
         -"Liver enzyme D1",
         -"Coagulation index D1",
         -"Inflammatory indicator D1",
         -"Blood gas analysis",
         -"Virus nucleic acid test CT value",
         -"D3 time division (3 light, 3 medium, 3 heavy, and 4 critical)",
         -"Antiviral drugs (1 nema 0 no)", 
         -"Hormones (1 Yes 0 No)", 
         -"PCT greater than 0.5",
         -"PCT greater than 2", 
         -"PCT greater than 10", 
         -"Azvudine (1 is 0)",
         -"D3 time division (3 light, 3 medium, 3 heavy, and 4 critical)",
         -"Immunotherapy (1 Yes 0 No)",
         -"Use or D1- initial positive longer than 5d")
```

Relocate columns Age range and Age over 65 to the first columns of the dataset.

```{r}
data <- data |> 
  relocate("Age ranges[years]", "Age over 65(1,YES; 2, NO)", .after = "Number")
```

Rename some columns

```{r}
data <- data |> 
  rename(
    "Basic_diseases" = "Basic diseases (1 hypertension, 2 diabetes, 3 cardiovascular diseases, 4 cerebrovascular diseases, 5 COPD, 6 immunodeficiency (such as AIDS, hormone, immunosuppressant use history), 7 malignant tumor, 8 other 9 chronic kidney disease",
    "Age range" = "Age ranges[years]",
    "Age over 65" = "Age over 65(1,YES; 2, NO)",
    "Fever days" = "Fever days (D1-D7)[days]",
    "Affected lung lobes 1" = "Number of affected lung lobes 1",
    "Affected lung lobes 2" = "Number of affected lung lobes 2",
    "Imaging Improvement > 25% (after 1 week)" = "Does the imaging improve by more than 25% after one week (1 yes 2 no)",
    "APACHE Score (ICU Admission)" = "APACHEII score (admission to ICU)",
    "Usage days" = "Usage days[days]",
    "Hormone usage days" = "Hormone usage days[days]",
    "Anticoagulant days" = "Anticoagulant days[days]",
    "Death" = "Death (1 Yes 2 No)",
    "Symptoms" = "Symptoms (1. Whole body, 2. Respiratory, 3. Nervous, 4. Cardiovascular, 5. Gastrointestinal, 6. Other)",
    "Antiviral Drug" = "Antiviral drugs (1 nema, 2 azides, 3 others)",
    "Administration method" = "Administration method (1 oral and 2 nasal feeding)",
    "Hormones" = "Hormones (1 methylprednisolone, 2 dexamethasone, 3 others)",
    "Hospitalization days" = "Hospitalization time[days]",
    "ICU hospitalization days" = "ICU hospitalization time[days]",
    "Prone position ventilation" = "Prone position ventilation (1 yes 0 no)",
    "Mechanical ventilation days" = "Mechanical ventilation time (days)",
    "D1_oxygen_therapy_mode"
 = "D1 oxygen therapy mode (1. Mask 2. High flow oxygen therapy 3. Non invasive 4. Invasive 5. ECMO)",
 "Antibiotics" = "Antibiotics (1 Yes 2 No)",
 "Immunotherapy" = "Immunotherapy (1 Tor 2 Bar)",
 "Medication days" = "Medication- D1[days]"
    )
```

Create function to change dirty columns with multiple values to clean binary columns

```{r}
process_dirty_cols <- function(data, column, rename_map) {
  column_sym <- ensym(column)
  
  data_processed <- data |> 
    mutate(
      !!column_sym := str_replace_all(!!column_sym, "([^a-zA-Z()]*).*", "\\1")
    ) |>  
    # Crear varias filas para cada valor en la columna separada por comas o signos +
    separate_rows({{ column }}, sep = "[,+]") |> 
    # Asegurarse de que los valores sean numéricos, asignando 0 si no lo son
    mutate({{ column }} := as.numeric({{ column }})) |> 
    # Expandir las filas a columnas con indicadores binarios
    pivot_wider(
      names_from = {{ column }}, 
      names_prefix = "temp_prefix_",
      values_from = {{ column }}, 
      values_fn = ~1, 
      values_fill = 0
    )
  
  # Si la columna 'temp_prefix_NA' existe, filtrar sus valores
  if ("temp_prefix_NA" %in% names(data_processed)) {
    data_processed <- data_processed |> 
      mutate(across(starts_with("temp_prefix_"), ~if_else(temp_prefix_NA == 1, NA, .))) |> 
      select(-any_of(c("temp_prefix_NA", "temp_prefix_0")))
  } else {
    # Si no existe, simplemente eliminamos la columna 'temp_prefix_0' (si está presente)
    data_processed <- data_processed |> 
      select(-any_of(c("temp_prefix_0")))
  }
  
  # Renombrar columnas según el mapa proporcionado
  data_processed <- data_processed |> 
    rename_with(
      ~gsub(paste0("^", "temp_prefix_"), "", .),  # Elimina el prefijo "temp_prefix_" si está presente
      starts_with("temp_prefix_")
    ) |> 
    rename_with(~ case_when(
      . %in% names(rename_map) ~ rename_map[.],
      TRUE ~ .
    ), everything())
  
  return(data_processed)
}
```

Change the dirty columns

```{r}
#Basic_disease column
rename_map <- c(
  "1" = "Hypertension_disease",
  "2" = "Diabetes_disease",
  "3" = "CVD_disease",
  "4" = "Cerebrovascular_disease",
  "5" = "COPD_disease",
  "6" = "Immunodeficiency_disease",
  "7" = "Malignant_tumor_disease",
  "8" = "Other_disease",
  "9" = "Chronic_Kidney_disease"
)
data_clean3 <- process_dirty_cols(data, Basic_diseases, rename_map)

#Symptoms column
rename_map <- c(
  "1" = "Whole_body_symptoms",
  "2" = "Respiratory_symptoms",
  "3" = "Nervous_symptoms",
  "4" = "Cardiovascular_symptoms",
  "5" = "Gastrointestinal_symptoms",
  "6" = "Other_symptoms"
)
data_clean3 <- process_dirty_cols(data_clean3, Symptoms, rename_map)

#D1_oxygen_therapy_mode
rename_map <- c(
  "1" = "Mask_Oxygen_therapy",
  "2" = "NonInvasive_Oxygen_therapy",
  "3" = "HighFlow_Oxygen_therapy",
  "4" = "Invasive_Oxygen_therapy",
  "5" = "ECMO"
)
data_clean3 <- process_dirty_cols(data_clean3, D1_oxygen_therapy_mode, rename_map)
```

```{r}
data_final <- data_clean3 |> 
  mutate(`NRL[%]` = round(as.numeric(`NRL[%]`), 2)) |>
  mutate(`Antiviral Drug` = case_when(
    `Antiviral Drug` == 0 ~ "None",
    `Antiviral Drug` == 1 ~ "Paxlovid",
    `Antiviral Drug` == 2 ~ "Azduvine",
    `Antiviral Drug` == 3 ~ "Other",
    TRUE ~ NA_character_
  )) |> 
    mutate(`Administration method` = case_when(
    `Administration method` == 1 ~ "Oral feeding",
    `Administration method` == 2 ~ "Nasal Feeding",
    TRUE ~ NA_character_
  )) |>
    mutate(`Hormones` = case_when( #CUIDADO CON ESTOOOO
    `Hormones` == 1 ~ "Methylprednisolone",
    `Hormones` == 2 ~ "Dexamethasone",
    `Hormones` == 3 ~ "Other",
    TRUE ~ NA_character_
  )) |> 
    mutate(`Death` = case_when( 
    `Death` == 1 ~ "1",
    `Death` == 2 ~ "0",
    TRUE ~ NA_character_
  )) |> mutate(`ICU hospitalization days` = as.numeric(gsub("[^0-9\\.]", "", `ICU hospitalization days`))) |> 
  mutate(`Prone position ventilation` = case_when(
    `Prone position ventilation` == 1 ~ "yes",
    `Prone position ventilation` == 0 ~ "no",
    TRUE ~ NA_character_
  )) |> 
  mutate(`Antibiotics` = case_when(
    `Antibiotics` == 1 ~ "yes",
    `Antibiotics` == 2 ~ "no",
    TRUE ~ NA_character_
  )) |>
  mutate(`Immunotherapy` = case_when(
    `Immunotherapy` == 1 ~ "Tocilizumab",
    `Immunotherapy` == 2 ~ "Baricitinib",
    `Immunotherapy` == 0 ~ "None",
    TRUE ~ NA_character_
  )) |> 
  mutate(`Hormone dosage[mg]` = as.numeric(gsub("[^0-9\\.]", "", `Hormone dosage[mg]`))) |> 
  mutate(`Imaging Improvement > 25% (after 1 week)` = case_when(
    `Imaging Improvement > 25% (after 1 week)` == 1 ~ "yes",
    `Imaging Improvement > 25% (after 1 week)` == 2 ~ "no",
    TRUE ~ NA_character_
  )) |> mutate(`Age range` = case_when(
    str_detect(`Age range`, "^[0-5][0-9]-") ~ "<60",
    str_detect(`Age range`, "^6") ~ "60-70",
    str_detect(`Age range`, "^7") ~ "70-80",
    str_detect(`Age range`, "^8") ~ "80-90",
    str_detect(`Age range`, "^9") ~ ">90",
    str_detect(`Age range`, "^100") ~ ">90"
  )) |> mutate(`Age range` = fct_relevel(`Age range`, "<60", "60-70", "70-80", "80-90", ">90"))
```


